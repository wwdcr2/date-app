{% extends "base.html" %}

{% block title %}무드 캘린더 - 커플 앱{% endblock %}

{% block content %}
<div class="mood-calendar-container">
    <div class="calendar-header">
        <h1>📅 무드 캘린더</h1>
        <div class="calendar-navigation">
            <a href="{{ url_for('mood.calendar_view', year_month=prev_month) }}" class="btn btn-secondary">이전 달</a>
            <h2>{{ month_name }}</h2>
            <a href="{{ url_for('mood.calendar_view', year_month=next_month) }}" class="btn btn-secondary">다음 달</a>
        </div>
    </div>
    
    <div class="calendar-legend">
        <div class="legend-item">
            <span class="legend-color my-mood"></span>
            <span>{{ current_user.name }}</span>
        </div>
        {% if partner %}
        <div class="legend-item">
            <span class="legend-color partner-mood"></span>
            <span>{{ partner.name }}</span>
        </div>
        {% endif %}
    </div>
    
    <div class="calendar-grid">
        <div class="calendar-weekdays">
            <div class="weekday">일</div>
            <div class="weekday">월</div>
            <div class="weekday">화</div>
            <div class="weekday">수</div>
            <div class="weekday">목</div>
            <div class="weekday">금</div>
            <div class="weekday">토</div>
        </div>
        
        <div class="calendar-days">
            {% for week in calendar_data %}
                {% for day in week %}
                    {% if day == 0 %}
                        <div class="calendar-day empty"></div>
                    {% else %}
                        {% set is_today = (current_year == today.year and current_month == today.month and day == today.day) %}
                        {% set my_mood = my_mood_map.get(day) %}
                        {% set partner_mood = partner_mood_map.get(day) %}
                        
                        <div class="calendar-day {% if is_today %}today{% endif %}" data-date="{{ current_year }}-{{ '%02d'|format(current_month) }}-{{ '%02d'|format(day) }}">
                            <div class="day-number">{{ day }}</div>
                            <div class="day-moods">
                                {% if my_mood %}
                                    <div class="mood-indicator my-mood" title="{{ current_user.name }}: {{ my_mood.get_mood_text() }}">
                                        {{ my_mood.get_mood_emoji() }}
                                    </div>
                                {% endif %}
                                {% if partner_mood %}
                                    <div class="mood-indicator partner-mood" title="{{ partner.name }}: {{ partner_mood.get_mood_text() }}">
                                        {{ partner_mood.get_mood_emoji() }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </div>
    </div>
    
    <div class="calendar-actions">
        <a href="{{ url_for('mood.record') }}" class="btn btn-primary">기분 기록하기</a>
        <a href="{{ url_for('mood.index') }}" class="btn btn-secondary">무드 트래커 홈</a>
    </div>
</div>

<!-- 기분 상세 모달 -->
<div id="moodModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="modalDate"></h3>
        <div id="modalMoodContent"></div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.mood-calendar-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.calendar-header {
    text-align: center;
    margin-bottom: 20px;
}

.calendar-header h1 {
    color: var(--primary-color);
    margin-bottom: 15px;
}

.calendar-navigation {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
}

.calendar-navigation h2 {
    margin: 0;
    color: var(--text-color);
    min-width: 150px;
}

.calendar-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 50%;
}

.legend-color.my-mood {
    background: var(--primary-color);
}

.legend-color.partner-mood {
    background: var(--secondary-color);
}

.calendar-grid {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    margin-bottom: 10px;
}

.weekday {
    text-align: center;
    font-weight: bold;
    padding: 10px;
    color: var(--text-muted);
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
}

.calendar-day {
    min-height: 80px;
    border: 1px solid var(--border-color);
    padding: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    position: relative;
}

.calendar-day:hover {
    background-color: var(--background-color);
}

.calendar-day.today {
    background-color: var(--primary-light);
    border-color: var(--primary-color);
}

.calendar-day.empty {
    border: none;
    cursor: default;
}

.day-number {
    font-weight: 500;
    margin-bottom: 5px;
}

.day-moods {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}

.mood-indicator {
    font-size: 1.2rem;
    line-height: 1;
}

.calendar-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
}

/* 모달 스타일 */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 15% auto;
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    position: relative;
}

.close {
    position: absolute;
    right: 15px;
    top: 15px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: var(--primary-color);
}

@media (max-width: 768px) {
    .calendar-navigation {
        flex-direction: column;
        gap: 10px;
    }
    
    .calendar-legend {
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    
    .calendar-day {
        min-height: 60px;
        padding: 4px;
    }
    
    .day-number {
        font-size: 0.9rem;
    }
    
    .mood-indicator {
        font-size: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('moodModal');
    const closeBtn = document.querySelector('.close');
    const calendarDays = document.querySelectorAll('.calendar-day:not(.empty)');
    
    // 캘린더 날짜 클릭 이벤트
    calendarDays.forEach(day => {
        day.addEventListener('click', function() {
            const date = this.dataset.date;
            if (date) {
                showMoodDetails(date);
            }
        });
    });
    
    // 모달 닫기
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });
    
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    async function showMoodDetails(date) {
        try {
            const [year, month] = date.split('-');
            const response = await fetch(`/mood/api/monthly-data/${year}-${month}`);
            const data = await response.json();
            
            if (data.success) {
                const myMood = data.my_moods.find(mood => mood.date === date);
                const partnerMood = data.partner_moods.find(mood => mood.date === date);
                
                document.getElementById('modalDate').textContent = formatDate(date);
                
                let content = '<div class="modal-mood-details">';
                
                // 내 기분
                content += '<div class="modal-mood-item">';
                content += `<h4>{{ current_user.name }}님의 기분</h4>`;
                if (myMood) {
                    content += `<div class="mood-display">`;
                    content += `<span class="mood-emoji">${myMood.emoji}</span>`;
                    content += `<span class="mood-text">${myMood.text}</span>`;
                    content += `</div>`;
                    if (myMood.note) {
                        content += `<div class="mood-note">${myMood.note}</div>`;
                    }
                } else {
                    content += '<p class="no-mood">기분을 기록하지 않았습니다.</p>';
                }
                content += '</div>';
                
                // 파트너 기분
                {% if partner %}
                content += '<div class="modal-mood-item">';
                content += `<h4>{{ partner.name }}님의 기분</h4>`;
                if (partnerMood) {
                    content += `<div class="mood-display">`;
                    content += `<span class="mood-emoji">${partnerMood.emoji}</span>`;
                    content += `<span class="mood-text">${partnerMood.text}</span>`;
                    content += `</div>`;
                    if (partnerMood.note) {
                        content += `<div class="mood-note">${partnerMood.note}</div>`;
                    }
                } else {
                    content += '<p class="no-mood">기분을 기록하지 않았습니다.</p>';
                }
                content += '</div>';
                {% endif %}
                
                content += '</div>';
                
                // 기분 기록 버튼 (오늘 또는 과거 날짜인 경우)
                const today = new Date().toISOString().split('T')[0];
                if (date <= today) {
                    content += `<div class="modal-actions">`;
                    content += `<a href="/mood/record?date=${date}" class="btn btn-primary btn-sm">`;
                    content += myMood ? '기분 수정하기' : '기분 기록하기';
                    content += `</a></div>`;
                }
                
                document.getElementById('modalMoodContent').innerHTML = content;
                modal.style.display = 'block';
            }
        } catch (error) {
            console.error('기분 상세 정보 로딩 실패:', error);
        }
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
    }
});
</script>
{% endblock %}