{% extends "base.html" %}

{% block title %}ì•Œë¦¼ - ì»¤í”Œ ì•±{% endblock %}

{% block content %}
<div class="notifications-page">
    <div class="notifications-header">
        <h1>ğŸ”” ì•Œë¦¼</h1>
        <div class="notifications-actions">
            <button id="mark-all-read-btn" class="btn btn-secondary btn-sm">ëª¨ë‘ ì½ìŒ ì²˜ë¦¬</button>
            <button id="clear-read-btn" class="btn btn-outline btn-sm">ì½ì€ ì•Œë¦¼ ì‚­ì œ</button>
        </div>
    </div>
    
    <div class="notifications-filters">
        <div class="filter-group">
            <label>
                <input type="checkbox" id="show-read-filter" {% if show_read %}checked{% endif %}>
                ì½ì€ ì•Œë¦¼ë„ í‘œì‹œ
            </label>
        </div>
        
        <div class="filter-group">
            <select id="type-filter">
                <option value="">ëª¨ë“  ì•Œë¦¼</option>
                {% for type in notification_types %}
                <option value="{{ type }}" {% if current_filter == type %}selected{% endif %}>
                    {% if type == 'mood_update' %}ê¸°ë¶„ ì—…ë°ì´íŠ¸
                    {% elif type == 'new_answer' %}ìƒˆë¡œìš´ ë‹µë³€
                    {% elif type == 'event_reminder' %}ì¼ì • ì•Œë¦¼
                    {% elif type == 'dday_reminder' %}D-Day ì•Œë¦¼
                    {% elif type == 'new_memory' %}ìƒˆë¡œìš´ ì¶”ì–µ
                    {% elif type == 'partner_connected' %}íŒŒíŠ¸ë„ˆ ì—°ê²°
                    {% else %}{{ type }}
                    {% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
    
    <div class="notifications-list">
        {% if notifications.items %}
            {% for notification in notifications.items %}
            <div class="notification-item-page {% if not notification.is_read %}unread{% endif %}" 
                 data-notification-id="{{ notification.id }}">
                <div class="notification-icon" style="color: {{ notification.get_type_color() }}">
                    {{ notification.get_type_icon() }}
                </div>
                <div class="notification-content">
                    <div class="notification-title">{{ notification.title }}</div>
                    <div class="notification-message">{{ notification.content }}</div>
                    <div class="notification-time">{{ notification.get_formatted_time() }}</div>
                </div>
                <div class="notification-actions">
                    {% if not notification.is_read %}
                    <button class="btn-icon mark-read-btn" data-notification-id="{{ notification.id }}" title="ì½ìŒ ì²˜ë¦¬">
                        âœ“
                    </button>
                    {% endif %}
                    <button class="btn-icon delete-btn" data-notification-id="{{ notification.id }}" title="ì‚­ì œ">
                        ğŸ—‘ï¸
                    </button>
                </div>
                {% if not notification.is_read %}
                <div class="unread-indicator"></div>
                {% endif %}
            </div>
            {% endfor %}
            
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            {% if notifications.pages > 1 %}
            <div class="pagination">
                {% if notifications.has_prev %}
                    <a href="{{ url_for('notifications.index', page=notifications.prev_num, type=current_filter, show_read=show_read) }}" class="btn btn-secondary btn-sm">ì´ì „</a>
                {% endif %}
                
                <span class="pagination-info">
                    {{ notifications.page }} / {{ notifications.pages }} í˜ì´ì§€
                </span>
                
                {% if notifications.has_next %}
                    <a href="{{ url_for('notifications.index', page=notifications.next_num, type=current_filter, show_read=show_read) }}" class="btn btn-secondary btn-sm">ë‹¤ìŒ</a>
                {% endif %}
            </div>
            {% endif %}
        {% else %}
            <div class="no-notifications">
                <div class="no-notifications-icon">ğŸ”•</div>
                <div class="no-notifications-text">
                    {% if show_read %}
                        ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.
                    {% else %}
                        ì½ì§€ ì•Šì€ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.notifications-page {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.notifications-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.notifications-header h1 {
    color: var(--primary-color);
    margin: 0;
}

.notifications-actions {
    display: flex;
    gap: 10px;
}

.notifications-filters {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-group label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
    cursor: pointer;
}

.filter-group select {
    padding: 6px 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.9rem;
}

.notifications-list {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.notification-item-page {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    position: relative;
    transition: background-color 0.2s;
}

.notification-item-page:hover {
    background-color: var(--background-color);
}

.notification-item-page.unread {
    background-color: #F8F9FA;
}

.notification-item-page:last-child {
    border-bottom: none;
}

.notification-icon {
    font-size: 1.8rem;
    flex-shrink: 0;
    margin-top: 2px;
}

.notification-content {
    flex: 1;
    min-width: 0;
}

.notification-title {
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: 6px;
    line-height: 1.3;
}

.notification-message {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-bottom: 8px;
    line-height: 1.4;
}

.notification-time {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.notification-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
}

.btn-icon {
    background: none;
    border: none;
    padding: 6px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.2s;
}

.btn-icon:hover {
    background-color: var(--border-color);
}

.mark-read-btn {
    color: var(--success-color);
}

.delete-btn {
    color: var(--danger-color);
}

.unread-indicator {
    position: absolute;
    top: 20px;
    right: 15px;
    width: 8px;
    height: 8px;
    background: var(--primary-color);
    border-radius: 50%;
}

.no-notifications {
    text-align: center;
    padding: 60px 20px;
}

.no-notifications-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.no-notifications-text {
    color: var(--text-muted);
    font-size: 1.1rem;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    padding: 20px;
    border-top: 1px solid var(--border-color);
}

.pagination-info {
    font-size: 0.9rem;
    color: var(--text-muted);
}

@media (max-width: 768px) {
    .notifications-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .notifications-actions {
        justify-content: center;
    }
    
    .notifications-filters {
        flex-direction: column;
        gap: 15px;
    }
    
    .notification-item-page {
        padding: 15px;
        gap: 12px;
    }
    
    .notification-actions {
        flex-direction: column;
        gap: 4px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // í•„í„° ë³€ê²½ ì´ë²¤íŠ¸
    const showReadFilter = document.getElementById('show-read-filter');
    const typeFilter = document.getElementById('type-filter');
    
    function updateFilters() {
        const showRead = showReadFilter.checked;
        const type = typeFilter.value;
        
        const url = new URL(window.location);
        url.searchParams.set('show_read', showRead);
        if (type) {
            url.searchParams.set('type', type);
        } else {
            url.searchParams.delete('type');
        }
        url.searchParams.delete('page'); // í˜ì´ì§€ ë¦¬ì…‹
        
        window.location.href = url.toString();
    }
    
    showReadFilter.addEventListener('change', updateFilters);
    typeFilter.addEventListener('change', updateFilters);
    
    // ëª¨ë‘ ì½ìŒ ì²˜ë¦¬
    document.getElementById('mark-all-read-btn').addEventListener('click', async function() {
        if (!confirm('ëª¨ë“  ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        try {
            const response = await fetch('/notifications/mark-all-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            if (data.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
    
    // ì½ì€ ì•Œë¦¼ ì‚­ì œ
    document.getElementById('clear-read-btn').addEventListener('click', async function() {
        if (!confirm('ì½ì€ ì•Œë¦¼ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        try {
            const response = await fetch('/notifications/clear-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            if (data.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
    
    // ê°œë³„ ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
    document.querySelectorAll('.mark-read-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const notificationId = this.dataset.notificationId;
            
            try {
                const response = await fetch(`/notifications/mark-read/${notificationId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    const item = this.closest('.notification-item-page');
                    item.classList.remove('unread');
                    item.classList.add('read');
                    
                    const unreadIndicator = item.querySelector('.unread-indicator');
                    if (unreadIndicator) {
                        unreadIndicator.remove();
                    }
                    
                    this.remove();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    });
    
    // ê°œë³„ ì•Œë¦¼ ì‚­ì œ
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!confirm('ì´ ì•Œë¦¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            const notificationId = this.dataset.notificationId;
            
            try {
                const response = await fetch(`/notifications/delete/${notificationId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    this.closest('.notification-item-page').remove();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    });
});
</script>
{% endblock %}