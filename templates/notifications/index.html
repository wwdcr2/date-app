{% extends "base.html" %}

{% block title %}알림 - 커플 앱{% endblock %}

{% block content %}
<div class="notifications-page">
    <div class="notifications-header">
        <h1>🔔 알림</h1>
        <div class="notifications-actions">
            <button id="mark-all-read-btn" class="btn btn-secondary btn-sm">모두 읽음 처리</button>
            <button id="clear-read-btn" class="btn btn-outline btn-sm">읽은 알림 삭제</button>
        </div>
    </div>
    
    <div class="notifications-filters">
        <div class="filter-group">
            <label>
                <input type="checkbox" id="show-read-filter" {% if show_read %}checked{% endif %}>
                읽은 알림도 표시
            </label>
        </div>
        
        <div class="filter-group">
            <select id="type-filter">
                <option value="">모든 알림</option>
                {% for type in notification_types %}
                <option value="{{ type }}" {% if current_filter == type %}selected{% endif %}>
                    {% if type == 'mood_update' %}기분 업데이트
                    {% elif type == 'new_answer' %}새로운 답변
                    {% elif type == 'event_reminder' %}일정 알림
                    {% elif type == 'dday_reminder' %}D-Day 알림
                    {% elif type == 'new_memory' %}새로운 추억
                    {% elif type == 'partner_connected' %}파트너 연결
                    {% else %}{{ type }}
                    {% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
    
    <div class="notifications-list">
        {% if notifications.items %}
            {% for notification in notifications.items %}
            <div class="notification-item-page {% if not notification.is_read %}unread{% endif %}" 
                 data-notification-id="{{ notification.id }}">
                <div class="notification-icon" style="color: {{ notification.get_type_color() }}">
                    {{ notification.get_type_icon() }}
                </div>
                <div class="notification-content">
                    <div class="notification-title">{{ notification.title }}</div>
                    <div class="notification-message">{{ notification.content }}</div>
                    <div class="notification-time">{{ notification.get_formatted_time() }}</div>
                </div>
                <div class="notification-actions">
                    {% if not notification.is_read %}
                    <button class="btn-icon mark-read-btn" data-notification-id="{{ notification.id }}" title="읽음 처리">
                        ✓
                    </button>
                    {% endif %}
                    <button class="btn-icon delete-btn" data-notification-id="{{ notification.id }}" title="삭제">
                        🗑️
                    </button>
                </div>
                {% if not notification.is_read %}
                <div class="unread-indicator"></div>
                {% endif %}
            </div>
            {% endfor %}
            
            <!-- 페이지네이션 -->
            {% if notifications.pages > 1 %}
            <div class="pagination">
                {% if notifications.has_prev %}
                    <a href="{{ url_for('notifications.index', page=notifications.prev_num, type=current_filter, show_read=show_read) }}" class="btn btn-secondary btn-sm">이전</a>
                {% endif %}
                
                <span class="pagination-info">
                    {{ notifications.page }} / {{ notifications.pages }} 페이지
                </span>
                
                {% if notifications.has_next %}
                    <a href="{{ url_for('notifications.index', page=notifications.next_num, type=current_filter, show_read=show_read) }}" class="btn btn-secondary btn-sm">다음</a>
                {% endif %}
            </div>
            {% endif %}
        {% else %}
            <div class="no-notifications">
                <div class="no-notifications-icon">🔕</div>
                <div class="no-notifications-text">
                    {% if show_read %}
                        알림이 없습니다.
                    {% else %}
                        읽지 않은 알림이 없습니다.
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.notifications-page {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.notifications-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.notifications-header h1 {
    color: var(--primary-color);
    margin: 0;
}

.notifications-actions {
    display: flex;
    gap: 10px;
}

.notifications-filters {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-group label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
    cursor: pointer;
}

.filter-group select {
    padding: 6px 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.9rem;
}

.notifications-list {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.notification-item-page {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    position: relative;
    transition: background-color 0.2s;
}

.notification-item-page:hover {
    background-color: var(--background-color);
}

.notification-item-page.unread {
    background-color: #F8F9FA;
}

.notification-item-page:last-child {
    border-bottom: none;
}

.notification-icon {
    font-size: 1.8rem;
    flex-shrink: 0;
    margin-top: 2px;
}

.notification-content {
    flex: 1;
    min-width: 0;
}

.notification-title {
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: 6px;
    line-height: 1.3;
}

.notification-message {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-bottom: 8px;
    line-height: 1.4;
}

.notification-time {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.notification-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
}

.btn-icon {
    background: none;
    border: none;
    padding: 6px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.2s;
}

.btn-icon:hover {
    background-color: var(--border-color);
}

.mark-read-btn {
    color: var(--success-color);
}

.delete-btn {
    color: var(--danger-color);
}

.unread-indicator {
    position: absolute;
    top: 20px;
    right: 15px;
    width: 8px;
    height: 8px;
    background: var(--primary-color);
    border-radius: 50%;
}

.no-notifications {
    text-align: center;
    padding: 60px 20px;
}

.no-notifications-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.no-notifications-text {
    color: var(--text-muted);
    font-size: 1.1rem;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    padding: 20px;
    border-top: 1px solid var(--border-color);
}

.pagination-info {
    font-size: 0.9rem;
    color: var(--text-muted);
}

@media (max-width: 768px) {
    .notifications-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .notifications-actions {
        justify-content: center;
    }
    
    .notifications-filters {
        flex-direction: column;
        gap: 15px;
    }
    
    .notification-item-page {
        padding: 15px;
        gap: 12px;
    }
    
    .notification-actions {
        flex-direction: column;
        gap: 4px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 필터 변경 이벤트
    const showReadFilter = document.getElementById('show-read-filter');
    const typeFilter = document.getElementById('type-filter');
    
    function updateFilters() {
        const showRead = showReadFilter.checked;
        const type = typeFilter.value;
        
        const url = new URL(window.location);
        url.searchParams.set('show_read', showRead);
        if (type) {
            url.searchParams.set('type', type);
        } else {
            url.searchParams.delete('type');
        }
        url.searchParams.delete('page'); // 페이지 리셋
        
        window.location.href = url.toString();
    }
    
    showReadFilter.addEventListener('change', updateFilters);
    typeFilter.addEventListener('change', updateFilters);
    
    // 모두 읽음 처리
    document.getElementById('mark-all-read-btn').addEventListener('click', async function() {
        if (!confirm('모든 알림을 읽음으로 처리하시겠습니까?')) return;
        
        try {
            const response = await fetch('/notifications/mark-all-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            if (data.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('오류가 발생했습니다.');
        }
    });
    
    // 읽은 알림 삭제
    document.getElementById('clear-read-btn').addEventListener('click', async function() {
        if (!confirm('읽은 알림을 모두 삭제하시겠습니까?')) return;
        
        try {
            const response = await fetch('/notifications/clear-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            if (data.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('오류가 발생했습니다.');
        }
    });
    
    // 개별 알림 읽음 처리
    document.querySelectorAll('.mark-read-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const notificationId = this.dataset.notificationId;
            
            try {
                const response = await fetch(`/notifications/mark-read/${notificationId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    const item = this.closest('.notification-item-page');
                    item.classList.remove('unread');
                    item.classList.add('read');
                    
                    const unreadIndicator = item.querySelector('.unread-indicator');
                    if (unreadIndicator) {
                        unreadIndicator.remove();
                    }
                    
                    this.remove();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('오류가 발생했습니다.');
            }
        });
    });
    
    // 개별 알림 삭제
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!confirm('이 알림을 삭제하시겠습니까?')) return;
            
            const notificationId = this.dataset.notificationId;
            
            try {
                const response = await fetch(`/notifications/delete/${notificationId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    this.closest('.notification-item-page').remove();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('오류가 발생했습니다.');
            }
        });
    });
});
</script>
{% endblock %}