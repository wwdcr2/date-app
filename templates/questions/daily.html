{% extends "base.html" %}

{% block title %}ì˜¤ëŠ˜ì˜ ì§ˆë¬¸{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- í—¤ë” -->
            <div class="text-center mb-4">
                <h2>ğŸ“ ì˜¤ëŠ˜ì˜ ì§ˆë¬¸</h2>
                <p class="text-muted">ì„œë¡œë¥¼ ë” ê¹Šì´ ì•Œì•„ê°€ëŠ” ì‹œê°„</p>
            </div>

            {% if question %}
            <!-- ì§ˆë¬¸ ì¹´ë“œ -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-primary me-2">
                            {{ categories[question.category]['emoji'] }} {{ categories[question.category]['name'] }}
                        </span>
                        <span class="badge" style="background-color: {{ difficulties[question.difficulty]['color'] }}">
                            {{ difficulties[question.difficulty]['name'] }}
                        </span>
                    </div>
                    <small class="text-muted">{{ daily_question.date.strftime('%Yë…„ %mì›” %dì¼') }}</small>
                </div>
                <div class="card-body">
                    <h4 class="card-title mb-4">{{ question.text }}</h4>
                    
                    <!-- ë‚´ ë‹µë³€ ì„¹ì…˜ -->
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="fas fa-user me-2"></i>ë‚´ ë‹µë³€
                        </h5>
                        
                        {% if my_answer %}
                        <div class="alert alert-success">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <p class="mb-2">{{ my_answer.answer_text }}</p>
                                    <small class="text-muted">
                                        ì‘ì„±ì¼: {{ my_answer.created_at.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }}
                                        {% if my_answer.updated_at %}
                                        (ìˆ˜ì •ë¨: {{ my_answer.updated_at.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }})
                                        {% endif %}
                                    </small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="editAnswer()">
                                    <i class="fas fa-edit"></i> ìˆ˜ì •
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <div class="answer-form">
                            <textarea class="form-control" id="answer-text" rows="4" 
                                      placeholder="ë‹¹ì‹ ì˜ ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                            <div class="mt-3 d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> ë‹µë³€ì„ ì‘ì„±í•˜ë©´ íŒŒíŠ¸ë„ˆì˜ ë‹µë³€ì„ ë³¼ ìˆ˜ ìˆì–´ìš”
                                </small>
                                <button type="button" class="btn btn-primary" onclick="submitAnswer()">
                                    <i class="fas fa-paper-plane"></i> ë‹µë³€ ì œì¶œ
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- íŒŒíŠ¸ë„ˆ ë‹µë³€ ì„¹ì…˜ -->
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="fas fa-heart me-2"></i>{{ partner.name if partner else 'íŒŒíŠ¸ë„ˆ' }}ì˜ ë‹µë³€
                        </h5>
                        
                        {% if can_view_partner %}
                            {% if partner_answer %}
                            <div class="alert alert-info">
                                <p class="mb-2">{{ partner_answer.answer_text }}</p>
                                <small class="text-muted">
                                    ì‘ì„±ì¼: {{ partner_answer.created_at.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }}
                                    {% if partner_answer.updated_at %}
                                    (ìˆ˜ì •ë¨: {{ partner_answer.updated_at.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }})
                                    {% endif %}
                                </small>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-clock me-2"></i>
                                {{ partner.name if partner else 'íŒŒíŠ¸ë„ˆ' }}ê°€ ì•„ì§ ë‹µë³€í•˜ì§€ ì•Šì•˜ì–´ìš”.
                            </div>
                            {% endif %}
                        {% else %}
                        <div class="alert alert-secondary">
                            <i class="fas fa-lock me-2"></i>
                            ë¨¼ì € ë‹µë³€ì„ ì‘ì„±í•˜ë©´ íŒŒíŠ¸ë„ˆì˜ ë‹µë³€ì„ ë³¼ ìˆ˜ ìˆì–´ìš”.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('questions.history') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-history"></i> ë‹µë³€ íˆìŠ¤í† ë¦¬
                </a>
                <a href="{{ url_for('questions.browse') }}" class="btn btn-outline-primary">
                    <i class="fas fa-search"></i> ì§ˆë¬¸ ë‘˜ëŸ¬ë³´ê¸°
                </a>
            </div>

            {% else %}
            <!-- ì§ˆë¬¸ì´ ì—†ëŠ” ê²½ìš° -->
            <div class="text-center py-5">
                <i class="fas fa-question-circle fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”</h4>
                <p class="text-muted">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                <a href="{{ url_for('questions.index') }}" class="btn btn-primary">
                    ì§ˆë¬¸ ë©”ì¸ìœ¼ë¡œ
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ë‹µë³€ ìˆ˜ì • ëª¨ë‹¬ -->
{% if my_answer %}
<div class="modal fade" id="editAnswerModal" tabindex="-1" aria-labelledby="editAnswerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAnswerModalLabel">ë‹µë³€ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="edit-answer-text" rows="4">{{ my_answer.answer_text }}</textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="updateAnswer()">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// ì „ì—­ ë³€ìˆ˜
const questionId = {{ question.id if question else 'null' }};
const questionDate = '{{ daily_question.date.isoformat() if daily_question else '' }}';

// ë‹µë³€ ì œì¶œ
function submitAnswer() {
    const answerText = document.getElementById('answer-text').value.trim();
    
    if (!answerText) {
        alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!questionId) {
        alert('ì§ˆë¬¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    const submitBtn = document.querySelector('button[onclick="submitAnswer()"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì œì¶œ ì¤‘...';
    
    fetch('{{ url_for("questions.answer") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question_id: questionId,
            answer: answerText,
            date: questionDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
            alert('ì˜¤ë¥˜: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ë‹µë³€ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    })
    .finally(() => {
        // ë²„íŠ¼ ë³µì›
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// ë‹µë³€ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
function editAnswer() {
    const modal = new bootstrap.Modal(document.getElementById('editAnswerModal'));
    modal.show();
}

// ë‹µë³€ ìˆ˜ì •
function updateAnswer() {
    const answerText = document.getElementById('edit-answer-text').value.trim();
    
    if (!answerText) {
        alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!questionId) {
        alert('ì§ˆë¬¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    fetch('{{ url_for("questions.answer") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question_id: questionId,
            answer: answerText,
            date: questionDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
            alert('ì˜¤ë¥˜: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ë‹µë³€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì—”í„° í‚¤ë¡œ ë‹µë³€ ì œì¶œ (Ctrl+Enter)
document.addEventListener('DOMContentLoaded', function() {
    const answerTextarea = document.getElementById('answer-text');
    if (answerTextarea) {
        answerTextarea.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                submitAnswer();
            }
        });
    }
});
</script>

<style>
.answer-form textarea {
    resize: vertical;
    min-height: 100px;
}

.card-header .badge {
    font-size: 0.8em;
}

.alert {
    border-left: 4px solid;
}

.alert-success {
    border-left-color: #28a745;
}

.alert-info {
    border-left-color: #17a2b8;
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-secondary {
    border-left-color: #6c757d;
}
</style>
{% endblock %}