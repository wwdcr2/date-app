{% extends "base.html" %}

{% block title %}ìº˜ë¦°ë” - ì»¤í”Œ ì•±{% endblock %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-header">
        <h1>ğŸ“… ìº˜ë¦°ë”</h1>
        <p>í•¨ê»˜í•˜ëŠ” ì†Œì¤‘í•œ ì¼ì •ë“¤ì„ ê´€ë¦¬í•´ë³´ì„¸ìš”</p>
        <div class="calendar-actions">
            <a href="{{ url_for('calendar.create') }}" class="btn btn-primary">ìƒˆ ì¼ì • ë“±ë¡</a>
        </div>
    </div>

    <div class="calendar-content">
        <!-- ìº˜ë¦°ë” ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="calendar-nav">
            <button class="btn-nav" onclick="changeMonth(-1)">â€¹</button>
            <h2 class="calendar-title" id="calendar-title">{{ year }}ë…„ {{ month }}ì›”</h2>
            <button class="btn-nav" onclick="changeMonth(1)">â€º</button>
        </div>

        <!-- ìº˜ë¦°ë” ê·¸ë¦¬ë“œ -->
        <div class="calendar-grid">
            <div class="calendar-weekdays">
                <div class="weekday">ì¼</div>
                <div class="weekday">ì›”</div>
                <div class="weekday">í™”</div>
                <div class="weekday">ìˆ˜</div>
                <div class="weekday">ëª©</div>
                <div class="weekday">ê¸ˆ</div>
                <div class="weekday">í† </div>
            </div>
            <div class="calendar-days" id="calendar-days">
                <!-- ë‚ ì§œë“¤ì´ JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ì„ íƒëœ ë‚ ì§œì˜ ì¼ì • ëª©ë¡ -->
        <div class="selected-date-events">
            <h3 id="selected-date-title">ì¼ì •ì„ ë³´ë ¤ë©´ ë‚ ì§œë¥¼ í´ë¦­í•˜ì„¸ìš”</h3>
            <div id="selected-date-events-list" class="events-list">
                <!-- ì„ íƒëœ ë‚ ì§œì˜ ì¼ì •ë“¤ì´ í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>
</div>

<!-- ì¼ì • ìƒì„¸ ëª¨ë‹¬ -->
<div id="eventModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="event-modal-title">ì¼ì • ìƒì„¸</h3>
            <button class="modal-close" onclick="closeEventModal()">&times;</button>
        </div>
        <div class="modal-body" id="event-modal-body">
            <!-- ì¼ì • ìƒì„¸ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEventModal()">ë‹«ê¸°</button>
            <button class="btn btn-primary" id="edit-event-btn" onclick="editEvent()">ìˆ˜ì •</button>
            <button class="btn btn-danger" id="delete-event-btn" onclick="deleteEvent()">ì‚­ì œ</button>
        </div>
    </div>
</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="deleteModal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h3>ì¼ì • ì‚­ì œ</h3>
            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <p><small>ì‚­ì œëœ ì¼ì •ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</small></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
            <button class="btn btn-danger" onclick="confirmDelete()">ì‚­ì œ</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ìº˜ë¦°ë” í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
.calendar-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--spacing-lg);
}

.calendar-header {
    text-align: center;
    margin-bottom: var(--spacing-2xl);
}

.calendar-header h1 {
    font-size: var(--text-3xl);
    font-weight: 700;
    color: var(--charcoal);
    margin-bottom: var(--spacing-sm);
}

.calendar-header p {
    font-size: var(--text-lg);
    color: var(--dark-gray);
    margin-bottom: var(--spacing-xl);
}

.calendar-actions {
    display: flex;
    justify-content: center;
}

.calendar-content {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: var(--spacing-2xl);
    align-items: start;
}

/* ìº˜ë¦°ë” ë„¤ë¹„ê²Œì´ì…˜ */
.calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-lg);
    background: var(--white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
}

.btn-nav {
    background: var(--accent-coral);
    color: var(--white);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: var(--text-lg);
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-nav:hover {
    background: #ff9f8f;
    transform: scale(1.1);
}

.calendar-title {
    font-size: var(--text-xl);
    font-weight: 600;
    color: var(--charcoal);
    margin: 0;
}

/* ìº˜ë¦°ë” ê·¸ë¦¬ë“œ */
.calendar-grid {
    background: var(--white);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    overflow: hidden;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: var(--light-gray);
}

.weekday {
    padding: var(--spacing-md);
    text-align: center;
    font-weight: 600;
    color: var(--charcoal);
    border-right: 1px solid var(--medium-gray);
}

.weekday:last-child {
    border-right: none;
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
}

.calendar-day {
    min-height: 100px;
    padding: var(--spacing-sm);
    border-right: 1px solid var(--medium-gray);
    border-bottom: 1px solid var(--medium-gray);
    cursor: pointer;
    transition: background-color 0.3s ease;
    position: relative;
}

.calendar-day:hover {
    background: var(--light-gray);
}

.calendar-day.selected {
    background: linear-gradient(135deg, var(--primary-pink), var(--primary-blue));
}

.calendar-day.other-month {
    color: var(--medium-gray);
    background: var(--light-gray);
}

.calendar-day.today {
    background: rgba(255, 181, 167, 0.3);
    font-weight: bold;
}

.calendar-day.today.selected {
    background: linear-gradient(135deg, var(--primary-pink), var(--primary-blue));
}

.day-number {
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
}

.day-events {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.day-event {
    font-size: var(--text-xs);
    padding: 2px 4px;
    border-radius: var(--radius-sm);
    background: var(--accent-coral);
    color: var(--white);
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
    cursor: pointer;
}

.day-event.user1 {
    background: var(--primary-pink);
    color: var(--charcoal);
}

.day-event.user2 {
    background: var(--primary-blue);
    color: var(--charcoal);
}

.day-event.both {
    background: var(--accent-coral);
    color: var(--white);
}

/* ì„ íƒëœ ë‚ ì§œ ì¼ì • */
.selected-date-events {
    background: var(--white);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    padding: var(--spacing-xl);
    position: sticky;
    top: calc(64px + var(--spacing-lg));
}

.selected-date-events h3 {
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--charcoal);
    margin-bottom: var(--spacing-lg);
    text-align: center;
}

.events-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.event-item {
    padding: var(--spacing-md);
    background: var(--light-gray);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 4px solid var(--accent-coral);
}

.event-item:hover {
    background: var(--medium-gray);
    transform: translateX(4px);
}

.event-item.user1 {
    border-left-color: var(--primary-pink);
}

.event-item.user2 {
    border-left-color: var(--primary-blue);
}

.event-item.both {
    border-left-color: var(--accent-coral);
}

.event-time {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--charcoal);
    margin-bottom: var(--spacing-xs);
}

.event-title {
    font-weight: 500;
    color: var(--charcoal);
    margin-bottom: var(--spacing-xs);
}

.event-participant {
    font-size: var(--text-xs);
    color: var(--dark-gray);
}

.empty-events {
    text-align: center;
    color: var(--dark-gray);
    font-style: italic;
    padding: var(--spacing-lg);
}

/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.event-details {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.event-detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--medium-gray);
}

.event-detail-item:last-child {
    border-bottom: none;
}

.event-detail-label {
    font-weight: 600;
    color: var(--charcoal);
}

.event-detail-value {
    color: var(--dark-gray);
    text-align: right;
}

.event-description {
    background: var(--light-gray);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    color: var(--charcoal);
    line-height: 1.6;
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
    .calendar-container {
        padding: 0 var(--spacing-md);
    }
    
    .calendar-header h1 {
        font-size: var(--text-2xl);
    }
    
    .calendar-header p {
        font-size: var(--text-base);
    }
    
    .calendar-content {
        grid-template-columns: 1fr;
        gap: var(--spacing-xl);
    }
    
    .calendar-day {
        min-height: 80px;
        padding: var(--spacing-xs);
    }
    
    .day-events {
        display: none; /* ëª¨ë°”ì¼ì—ì„œëŠ” ìº˜ë¦°ë” ì…€ì˜ ì´ë²¤íŠ¸ ìˆ¨ê¹€ */
    }
    
    .selected-date-events {
        position: static;
        order: -1;
    }
    
    .calendar-nav {
        padding: var(--spacing-md);
    }
    
    .calendar-title {
        font-size: var(--text-lg);
    }
}

@media (max-width: 480px) {
    .calendar-day {
        min-height: 60px;
        font-size: var(--text-sm);
    }
    
    .weekday {
        padding: var(--spacing-sm);
        font-size: var(--text-sm);
    }
    
    .btn-nav {
        width: 32px;
        height: 32px;
        font-size: var(--text-base);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentYear = {{ year }};
let currentMonth = {{ month }};
let selectedDate = null;
let currentEvents = [];
let selectedEventId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadCalendar();
});

async function loadCalendar() {
    try {
        // ìº˜ë¦°ë” ì œëª© ì—…ë°ì´íŠ¸
        document.getElementById('calendar-title').textContent = `${currentYear}ë…„ ${currentMonth}ì›”`;
        
        // ì´ë²¤íŠ¸ ë°ì´í„° ë¡œë“œ
        const response = await fetch(`/calendar/api/events?year=${currentYear}&month=${currentMonth}`);
        const data = await response.json();
        
        if (data.success) {
            currentEvents = data.events;
            renderCalendar();
        } else {
            console.error('ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', data.message);
        }
        
    } catch (error) {
        console.error('ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨:', error);
    }
}

function renderCalendar() {
    const calendarDays = document.getElementById('calendar-days');
    calendarDays.innerHTML = '';
    
    // í•´ë‹¹ ì›”ì˜ ì²«ì§¸ ë‚ ê³¼ ë§ˆì§€ë§‰ ë‚ 
    const firstDay = new Date(currentYear, currentMonth - 1, 1);
    const lastDay = new Date(currentYear, currentMonth, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay();
    
    // ì´ì „ ë‹¬ì˜ ë§ˆì§€ë§‰ ë‚ ë“¤
    const prevMonth = new Date(currentYear, currentMonth - 2, 0);
    const prevMonthDays = prevMonth.getDate();
    
    for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const dayElement = createDayElement(prevMonthDays - i, true);
        calendarDays.appendChild(dayElement);
    }
    
    // í˜„ì¬ ë‹¬ì˜ ë‚ ë“¤
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = createDayElement(day, false);
        calendarDays.appendChild(dayElement);
    }
    
    // ë‹¤ìŒ ë‹¬ì˜ ì²« ë‚ ë“¤ (6ì£¼ ì™„ì„±ì„ ìœ„í•´)
    const totalCells = calendarDays.children.length;
    const remainingCells = 42 - totalCells; // 6ì£¼ * 7ì¼
    
    for (let day = 1; day <= remainingCells; day++) {
        const dayElement = createDayElement(day, true);
        calendarDays.appendChild(dayElement);
    }
}

function createDayElement(day, isOtherMonth) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    if (isOtherMonth) {
        dayElement.classList.add('other-month');
    }
    
    // ì˜¤ëŠ˜ ë‚ ì§œ ì²´í¬
    const today = new Date();
    if (!isOtherMonth && 
        currentYear === today.getFullYear() && 
        currentMonth === today.getMonth() + 1 && 
        day === today.getDate()) {
        dayElement.classList.add('today');
    }
    
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = day;
    dayElement.appendChild(dayNumber);
    
    // í•´ë‹¹ ë‚ ì§œì˜ ì´ë²¤íŠ¸ í‘œì‹œ
    if (!isOtherMonth) {
        const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEvents = currentEvents.filter(event => event.start_date === dateStr);
        
        if (dayEvents.length > 0) {
            const eventsContainer = document.createElement('div');
            eventsContainer.className = 'day-events';
            
            dayEvents.slice(0, 3).forEach(event => { // ìµœëŒ€ 3ê°œë§Œ í‘œì‹œ
                const eventElement = document.createElement('div');
                eventElement.className = `day-event ${event.participant_type}`;
                eventElement.textContent = event.title;
                eventElement.onclick = (e) => {
                    e.stopPropagation();
                    showEventModal(event);
                };
                eventsContainer.appendChild(eventElement);
            });
            
            if (dayEvents.length > 3) {
                const moreElement = document.createElement('div');
                moreElement.className = 'day-event';
                moreElement.textContent = `+${dayEvents.length - 3}ê°œ ë”`;
                eventsContainer.appendChild(moreElement);
            }
            
            dayElement.appendChild(eventsContainer);
        }
        
        // ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸
        dayElement.onclick = () => selectDate(currentYear, currentMonth, day);
    }
    
    return dayElement;
}

function selectDate(year, month, day) {
    // ì´ì „ ì„ íƒ í•´ì œ
    document.querySelectorAll('.calendar-day.selected').forEach(el => {
        el.classList.remove('selected');
    });
    
    // ìƒˆë¡œìš´ ë‚ ì§œ ì„ íƒ
    event.currentTarget.classList.add('selected');
    
    selectedDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    // ì„ íƒëœ ë‚ ì§œì˜ ì´ë²¤íŠ¸ í‘œì‹œ
    showSelectedDateEvents(selectedDate);
}

async function showSelectedDateEvents(dateStr) {
    const title = document.getElementById('selected-date-title');
    const eventsList = document.getElementById('selected-date-events-list');
    
    const date = new Date(dateStr);
    const formattedDate = date.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
    });
    
    title.textContent = formattedDate;
    
    try {
        const response = await fetch(`/calendar/api/events/${dateStr}`);
        const data = await response.json();
        
        if (data.success) {
            if (data.events.length === 0) {
                eventsList.innerHTML = '<div class="empty-events">ì´ ë‚ ì—ëŠ” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                eventsList.innerHTML = data.events.map(event => `
                    <div class="event-item ${event.participant_type}" onclick="showEventModal(${JSON.stringify(event).replace(/"/g, '&quot;')})">
                        <div class="event-time">${event.start_time} - ${event.end_time}</div>
                        <div class="event-title">${event.title}</div>
                        <div class="event-participant">${event.participant_text}</div>
                    </div>
                `).join('');
            }
        }
        
    } catch (error) {
        console.error('ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        eventsList.innerHTML = '<div class="empty-events">ì´ë²¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
}

function changeMonth(delta) {
    currentMonth += delta;
    
    if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
    } else if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
    }
    
    loadCalendar();
}

function showEventModal(event) {
    selectedEventId = event.id;
    
    document.getElementById('event-modal-title').textContent = event.title;
    
    const modalBody = document.getElementById('event-modal-body');
    modalBody.innerHTML = `
        <div class="event-details">
            <div class="event-detail-item">
                <span class="event-detail-label">ë‚ ì§œ</span>
                <span class="event-detail-value">${event.start_date}</span>
            </div>
            <div class="event-detail-item">
                <span class="event-detail-label">ì‹œê°„</span>
                <span class="event-detail-value">${event.start_time} - ${event.end_time}</span>
            </div>
            <div class="event-detail-item">
                <span class="event-detail-label">ì°¸ì—¬ì</span>
                <span class="event-detail-value">${event.participant_text}</span>
            </div>
            ${event.description ? `
                <div class="event-detail-item">
                    <span class="event-detail-label">ì„¤ëª…</span>
                </div>
                <div class="event-description">${event.description}</div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('eventModal').style.display = 'flex';
}

function closeEventModal() {
    selectedEventId = null;
    document.getElementById('eventModal').style.display = 'none';
}

function editEvent() {
    if (selectedEventId) {
        window.location.href = `/calendar/${selectedEventId}/edit`;
    }
}

function deleteEvent() {
    if (selectedEventId) {
        document.getElementById('deleteModal').style.display = 'flex';
    }
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

async function confirmDelete() {
    if (!selectedEventId) return;
    
    try {
        const response = await fetch(`/calendar/${selectedEventId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            closeDeleteModal();
            closeEventModal();
            loadCalendar();
            
            // ì„ íƒëœ ë‚ ì§œê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë‚ ì§œ ì´ë²¤íŠ¸ ìƒˆë¡œê³ ì¹¨
            if (selectedDate) {
                showSelectedDateEvents(selectedDate);
            }
        } else {
            showToast(data.message, 'error');
        }
        
    } catch (error) {
        console.error('ì¼ì • ì‚­ì œ ì‹¤íŒ¨:', error);
        showToast('ì¼ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEventModal();
        closeDeleteModal();
    }
});
</script>
{% endblock %}