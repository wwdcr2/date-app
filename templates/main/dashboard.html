{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - ì»¤í”Œ ì•±{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>ì•ˆë…•í•˜ì„¸ìš”, {{ current_user.name }}ë‹˜! ğŸ‘‹</h1>
        {% if current_user.is_connected_to_partner() %}
            <p>{{ current_user.get_partner().name }}ë‹˜ê³¼ í•¨ê»˜í•˜ëŠ” íŠ¹ë³„í•œ ê³µê°„ì…ë‹ˆë‹¤.</p>
        {% else %}
            <p>íŒŒíŠ¸ë„ˆì™€ ì—°ê²°í•˜ì—¬ ë” ë§ì€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.</p>
        {% endif %}
    </div>
    
    {% if not current_user.is_connected_to_partner() %}
    <div class="connection-card">
        <div class="card-header">
            <h2>ğŸ’• íŒŒíŠ¸ë„ˆ ì—°ê²°</h2>
        </div>
        <div class="card-content">
            <p>íŒŒíŠ¸ë„ˆì™€ ì—°ê²°í•˜ì—¬ D-Day, ì¼ì •, ì§ˆë¬¸ ë“±ì˜ ê¸°ëŠ¥ì„ í•¨ê»˜ ì‚¬ìš©í•˜ì„¸ìš”.</p>
            <div class="connection-actions">
                <a href="{{ url_for('couple.connect') }}" class="btn btn-primary">íŒŒíŠ¸ë„ˆ ì—°ê²°í•˜ê¸°</a>
            </div>
        </div>
    </div>
    {% else %}
    <div class="dashboard-grid">
        <!-- D-Day ì¹´ë“œ -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3>ğŸ“… D-Day</h3>
                <a href="{{ url_for('dday.index') }}" class="card-link">ë”ë³´ê¸°</a>
            </div>
            <div class="card-content" id="dday-content">
                <div class="skeleton-loading">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text" style="width: 60%;"></div>
                </div>
            </div>
        </div>
        
        <!-- ì˜¤ëŠ˜ì˜ ì¼ì • ì¹´ë“œ -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3>ğŸ“‹ ì˜¤ëŠ˜ì˜ ì¼ì •</h3>
                <a href="{{ url_for('calendar.index') }}" class="card-link">ë”ë³´ê¸°</a>
            </div>
            <div class="card-content" id="events-content">
                <div class="skeleton-loading">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text" style="width: 40%;"></div>
                </div>
            </div>
        </div>
        
        <!-- ì˜¤ëŠ˜ì˜ ê¸°ë¶„ ì¹´ë“œ -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3>ğŸ˜Š ì˜¤ëŠ˜ì˜ ê¸°ë¶„</h3>
                <a href="#" class="card-link" onclick="recordMood(); return false;">ê¸°ë¶„ ê¸°ë¡</a>
            </div>
            <div class="card-content" id="mood-content">
                <div class="skeleton-loading">
                    <div class="mood-grid">
                        <div class="mood-item">
                            <div class="skeleton skeleton-text" style="width: 60%; margin: 0 auto;"></div>
                            <div class="skeleton skeleton-avatar" style="margin: 10px auto;"></div>
                        </div>
                        <div class="mood-item">
                            <div class="skeleton skeleton-text" style="width: 60%; margin: 0 auto;"></div>
                            <div class="skeleton skeleton-avatar" style="margin: 10px auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ ì¹´ë“œ -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3>â“ ì˜¤ëŠ˜ì˜ ì§ˆë¬¸</h3>
                <a href="{{ url_for('questions.daily') }}" class="card-link">ë‹µë³€í•˜ê¸°</a>
            </div>
            <div class="card-content">
                <p>ì„œë¡œë¥¼ ë” ê¹Šì´ ì•Œì•„ê°€ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”.</p>
                <a href="{{ url_for('questions.daily') }}" class="btn btn-secondary btn-sm">ì§ˆë¬¸ ë³´ê¸°</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>


{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if current_user.is_connected_to_partner() %}
    loadDashboardData();
    {% endif %}
});

async function loadDashboardData() {
    try {
        const response = await fetch('{{ url_for("main.dashboard_data") }}');
        const data = await response.json();
        
        updateDDayCard(data.ddays || []);
        updateEventsCard(data.today_events || []);
        updateMoodCard(data.today_moods || {});
        
    } catch (error) {
        console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
    }
}

function updateDDayCard(ddays) {
    const content = document.getElementById('dday-content');
    
    if (ddays.length === 0) {
        content.innerHTML = '<p class="empty-state">ë“±ë¡ëœ D-Dayê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    const ddayHtml = ddays.map(dday => `
        <div class="dday-item ${dday.is_past ? 'past' : ''}">
            <div class="dday-title">${dday.title}</div>
            <div class="dday-status">${dday.status_text}</div>
        </div>
    `).join('');
    
    content.innerHTML = ddayHtml;
}

function updateEventsCard(events) {
    const content = document.getElementById('events-content');
    
    if (events.length === 0) {
        content.innerHTML = '<p class="empty-state">ì˜¤ëŠ˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    const eventsHtml = events.map(event => `
        <div class="event-item">
            <div class="event-time">${event.start_time}</div>
            <div class="event-title">${event.title}</div>
            <div class="event-participant" style="color: ${event.participant_color}">
                ${event.participant_text}
            </div>
        </div>
    `).join('');
    
    content.innerHTML = eventsHtml;
}

function updateMoodCard(moods) {
    const content = document.getElementById('mood-content');
    
    const myMood = moods.my_mood;
    const partnerMood = moods.partner_mood;
    
    let moodHtml = '<div class="mood-grid">';
    
    // ë‚´ ê¸°ë¶„
    if (myMood) {
        moodHtml += `
            <div class="mood-item">
                <div class="mood-label">ë‚˜</div>
                <div class="mood-emoji">${myMood.emoji}</div>
                <div class="mood-text">${myMood.text}</div>
            </div>
        `;
    } else {
        moodHtml += `
            <div class="mood-item">
                <div class="mood-label">ë‚˜</div>
                <div class="mood-empty">ê¸°ë¶„ì„ ê¸°ë¡í•´ë³´ì„¸ìš”</div>
            </div>
        `;
    }
    
    // íŒŒíŠ¸ë„ˆ ê¸°ë¶„
    if (partnerMood) {
        moodHtml += `
            <div class="mood-item">
                <div class="mood-label">íŒŒíŠ¸ë„ˆ</div>
                <div class="mood-emoji">${partnerMood.emoji}</div>
                <div class="mood-text">${partnerMood.text}</div>
            </div>
        `;
    } else {
        moodHtml += `
            <div class="mood-item">
                <div class="mood-label">íŒŒíŠ¸ë„ˆ</div>
                <div class="mood-empty">ì•„ì§ ê¸°ë¡í•˜ì§€ ì•ŠìŒ</div>
            </div>
        `;
    }
    
    moodHtml += '</div>';
    content.innerHTML = moodHtml;
}

function recordMood() {
    // ê¸°ë¶„ ê¸°ë¡ ëª¨ë‹¬ ë˜ëŠ” í˜ì´ì§€ë¡œ ì´ë™
    // í˜„ì¬ëŠ” ê°„ë‹¨í•œ í”„ë¡¬í”„íŠ¸ë¡œ êµ¬í˜„
    const moodLevel = prompt('ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì„ 1-5ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš” (1: ë§¤ìš° ë‚˜ì¨, 5: ë§¤ìš° ì¢‹ìŒ):');
    
    if (moodLevel && moodLevel >= 1 && moodLevel <= 5) {
        const note = prompt('ê¸°ë¶„ì— ëŒ€í•œ ê°„ë‹¨í•œ ë©”ëª¨ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­):') || '';
        
        // ê¸°ë¶„ ê¸°ë¡ API í˜¸ì¶œ
        fetch('/mood/api/record', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                mood_level: parseInt(moodLevel),
                note: note,
                date: new Date().toISOString().split('T')[0]
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ê¸°ë¶„ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadDashboardData(); // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
            } else {
                alert('ê¸°ë¶„ ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
            }
        })
        .catch(error => {
            console.error('ê¸°ë¶„ ê¸°ë¡ ì˜¤ë¥˜:', error);
            alert('ê¸°ë¶„ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
}


</script>
{% endblock %}