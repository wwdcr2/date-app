{% extends "base.html" %}

{% block title %}í”„ë¡œí•„ - ì»¤í”Œ ì•±{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <h1>ğŸ‘¤ ë‚´ í”„ë¡œí•„</h1>
        <p>ê³„ì • ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
    </div>
    
    <div class="profile-content">
        <!-- ê¸°ë³¸ ì •ë³´ ì¹´ë“œ -->
        <div class="profile-card">
            <div class="card-header">
                <h3>ê¸°ë³¸ ì •ë³´</h3>
                <button class="btn btn-sm btn-secondary" onclick="toggleEditMode()">
                    <span id="edit-btn-text">ìˆ˜ì •</span>
                </button>
            </div>
            <div class="card-content">
                <div class="profile-info" id="profile-view">
                    <div class="info-item">
                        <label>ì´ë¦„</label>
                        <span>{{ current_user.name }}</span>
                    </div>
                    <div class="info-item">
                        <label>ì´ë©”ì¼</label>
                        <span>{{ current_user.email }}</span>
                    </div>
                    <div class="info-item">
                        <label>ê°€ì…ì¼</label>
                        <span>{{ current_user.created_at.strftime('%Yë…„ %mì›” %dì¼') }}</span>
                    </div>
                </div>
                
                <form class="profile-edit" id="profile-edit" style="display: none;">
                    <div class="form-group">
                        <label for="name">ì´ë¦„</label>
                        <input type="text" id="name" name="name" value="{{ current_user.name }}" required>
                        <div class="form-error" id="name-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="email">ì´ë©”ì¼</label>
                        <input type="email" id="email" name="email" value="{{ current_user.email }}" required>
                        <div class="form-error" id="email-error"></div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">ì €ì¥</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- íŒŒíŠ¸ë„ˆ ì •ë³´ ì¹´ë“œ -->
        <div class="profile-card">
            <div class="card-header">
                <h3>íŒŒíŠ¸ë„ˆ ì •ë³´</h3>
                {% if current_user.is_connected_to_partner() %}
                    <button class="btn btn-sm btn-outline" onclick="showDisconnectModal()">
                        ì—°ê²° í•´ì œ
                    </button>
                {% endif %}
            </div>
            <div class="card-content">
                {% if current_user.is_connected_to_partner() %}
                    {% set partner = current_user.get_partner() %}
                    <div class="partner-info">
                        <div class="partner-avatar">ğŸ’•</div>
                        <div class="partner-details">
                            <h4>{{ partner.name }}</h4>
                            <p>{{ partner.email }}</p>
                            <small>{{ partner.created_at.strftime('%Yë…„ %mì›” %dì¼') }} ê°€ì…</small>
                        </div>
                    </div>
                    <div class="connection-stats">
                        <div class="stat-item">
                            <span class="stat-label">ì—°ê²°ì¼</span>
                            <span class="stat-value">{{ current_user.get_couple_connection().connected_at.strftime('%Yë…„ %mì›” %dì¼') }}</span>
                        </div>
                    </div>
                {% else %}
                    <div class="no-partner">
                        <div class="no-partner-icon">ğŸ’”</div>
                        <p>ì•„ì§ íŒŒíŠ¸ë„ˆì™€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                        <a href="{{ url_for('couple.connect') }}" class="btn btn-primary">íŒŒíŠ¸ë„ˆ ì—°ê²°í•˜ê¸°</a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- ê³„ì • ì„¤ì • ì¹´ë“œ -->
        <div class="profile-card">
            <div class="card-header">
                <h3>ê³„ì • ì„¤ì •</h3>
            </div>
            <div class="card-content">
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h4>
                        <p>ê³„ì • ë³´ì•ˆì„ ìœ„í•´ ì •ê¸°ì ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì„¸ìš”</p>
                    </div>
                    <button class="btn btn-secondary" onclick="showPasswordModal()">
                        ë³€ê²½
                    </button>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>ê³„ì • ì‚­ì œ</h4>
                        <p>ê³„ì •ì„ ì‚­ì œí•˜ë©´ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤</p>
                    </div>
                    <button class="btn btn-outline btn-danger" onclick="showDeleteModal()">
                        ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
<div class="modal" id="password-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
            <button class="modal-close" onclick="hidePasswordModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="password-form">
                <div class="form-group">
                    <label for="current-password">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="current-password" name="current_password" required>
                    <div class="form-error" id="current-password-error"></div>
                </div>
                <div class="form-group">
                    <label for="new-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="new-password" name="new_password" required minlength="6">
                    <div class="form-error" id="new-password-error"></div>
                </div>
                <div class="form-group">
                    <label for="confirm-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" id="confirm-password" name="confirm_password" required>
                    <div class="form-error" id="confirm-password-error"></div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ë³€ê²½</button>
                    <button type="button" class="btn btn-secondary" onclick="hidePasswordModal()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ì—°ê²° í•´ì œ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal" id="disconnect-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>íŒŒíŠ¸ë„ˆ ì—°ê²° í•´ì œ</h3>
            <button class="modal-close" onclick="hideDisconnectModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>ì •ë§ë¡œ íŒŒíŠ¸ë„ˆì™€ì˜ ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <p><strong>ì£¼ì˜:</strong> ì—°ê²°ì„ í•´ì œí•˜ë©´ ê³µìœ ëœ ëª¨ë“  ë°ì´í„°(D-Day, ì¼ì •, ì¶”ì–µ ë“±)ì— ì ‘ê·¼í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.</p>
            <div class="form-actions">
                <button class="btn btn-danger" onclick="disconnectPartner()">ì—°ê²° í•´ì œ</button>
                <button class="btn btn-secondary" onclick="hideDisconnectModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<!-- ê³„ì • ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal" id="delete-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ê³„ì • ì‚­ì œ</h3>
            <button class="modal-close" onclick="hideDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>ì •ë§ë¡œ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <p><strong>ê²½ê³ :</strong> ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.</p>
            <div class="form-group">
                <label for="delete-confirm">ì‚­ì œë¥¼ í™•ì¸í•˜ë ¤ë©´ "ì‚­ì œ"ë¥¼ ì…ë ¥í•˜ì„¸ìš”</label>
                <input type="text" id="delete-confirm" placeholder="ì‚­ì œ">
            </div>
            <div class="form-actions">
                <button class="btn btn-danger" onclick="deleteAccount()" disabled id="delete-btn">ê³„ì • ì‚­ì œ</button>
                <button class="btn btn-secondary" onclick="hideDeleteModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.profile-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 var(--spacing-lg);
}

.profile-header {
    text-align: center;
    margin-bottom: var(--spacing-2xl);
}

.profile-header h1 {
    font-size: var(--text-3xl);
    margin-bottom: var(--spacing-sm);
    color: var(--charcoal);
}

.profile-header p {
    font-size: var(--text-lg);
    color: var(--dark-gray);
}

.profile-content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xl);
}

.profile-card {
    background: var(--white);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    overflow: hidden;
}

.profile-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--medium-gray);
    background: var(--light-gray);
}

.profile-card .card-header h3 {
    margin: 0;
    font-size: var(--text-lg);
    color: var(--charcoal);
}

.profile-card .card-content {
    padding: var(--spacing-lg);
}

.profile-info {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) 0;
    border-bottom: 1px solid var(--medium-gray);
}

.info-item:last-child {
    border-bottom: none;
}

.info-item label {
    font-weight: 600;
    color: var(--charcoal);
    margin: 0;
}

.info-item span {
    color: var(--dark-gray);
}

.partner-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
}

.partner-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-pink), var(--primary-blue));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-2xl);
}

.partner-details h4 {
    margin: 0 0 var(--spacing-xs) 0;
    color: var(--charcoal);
}

.partner-details p {
    margin: 0 0 var(--spacing-xs) 0;
    color: var(--dark-gray);
}

.partner-details small {
    color: var(--dark-gray);
    font-size: var(--text-sm);
}

.connection-stats {
    padding: var(--spacing-md);
    background: var(--light-gray);
    border-radius: var(--radius-md);
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.stat-label {
    font-weight: 500;
    color: var(--charcoal);
}

.stat-value {
    color: var(--dark-gray);
}

.no-partner {
    text-align: center;
    padding: var(--spacing-2xl);
}

.no-partner-icon {
    font-size: 4rem;
    margin-bottom: var(--spacing-lg);
    opacity: 0.5;
}

.no-partner p {
    margin-bottom: var(--spacing-lg);
    color: var(--dark-gray);
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-lg) 0;
    border-bottom: 1px solid var(--medium-gray);
}

.setting-item:last-child {
    border-bottom: none;
}

.setting-info h4 {
    margin: 0 0 var(--spacing-xs) 0;
    color: var(--charcoal);
}

.setting-info p {
    margin: 0;
    color: var(--dark-gray);
    font-size: var(--text-sm);
}

.btn-danger {
    background: var(--error);
    color: var(--white);
}

.btn-danger:hover {
    background: #c82333;
}

.btn-outline.btn-danger {
    background: transparent;
    border: 2px solid var(--error);
    color: var(--error);
}

.btn-outline.btn-danger:hover {
    background: var(--error);
    color: var(--white);
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
    .setting-item {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-md);
    }
    
    .partner-info {
        flex-direction: column;
        text-align: center;
    }
    
    .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-xs);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let isEditMode = false;

function toggleEditMode() {
    const profileView = document.getElementById('profile-view');
    const profileEdit = document.getElementById('profile-edit');
    const editBtnText = document.getElementById('edit-btn-text');
    
    if (isEditMode) {
        profileView.style.display = 'block';
        profileEdit.style.display = 'none';
        editBtnText.textContent = 'ìˆ˜ì •';
        isEditMode = false;
    } else {
        profileView.style.display = 'none';
        profileEdit.style.display = 'block';
        editBtnText.textContent = 'ì·¨ì†Œ';
        isEditMode = true;
    }
}

function cancelEdit() {
    toggleEditMode();
    // í¼ ë¦¬ì…‹
    document.getElementById('profile-edit').reset();
    clearErrors();
}

function showPasswordModal() {
    document.getElementById('password-modal').style.display = 'flex';
}

function hidePasswordModal() {
    document.getElementById('password-modal').style.display = 'none';
    document.getElementById('password-form').reset();
    clearErrors();
}

function showDisconnectModal() {
    document.getElementById('disconnect-modal').style.display = 'flex';
}

function hideDisconnectModal() {
    document.getElementById('disconnect-modal').style.display = 'none';
}

function showDeleteModal() {
    document.getElementById('delete-modal').style.display = 'flex';
}

function hideDeleteModal() {
    document.getElementById('delete-modal').style.display = 'none';
    document.getElementById('delete-confirm').value = '';
    document.getElementById('delete-btn').disabled = true;
}

// ê³„ì • ì‚­ì œ í™•ì¸ ì…ë ¥ ê²€ì¦
document.getElementById('delete-confirm').addEventListener('input', function() {
    const deleteBtn = document.getElementById('delete-btn');
    if (this.value === 'ì‚­ì œ') {
        deleteBtn.disabled = false;
    } else {
        deleteBtn.disabled = true;
    }
});

// ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ê²€ì¦
document.getElementById('confirm-password').addEventListener('input', function() {
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = this.value;
    const errorEl = document.getElementById('confirm-password-error');
    
    if (confirmPassword && newPassword !== confirmPassword) {
        errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    } else {
        errorEl.textContent = '';
    }
});

async function disconnectPartner() {
    try {
        const response = await fetch('{{ url_for("couple.disconnect") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showToast(result.error, 'error');
        }
    } catch (error) {
        showToast('ì—°ê²° í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    } finally {
        hideDisconnectModal();
    }
}

function deleteAccount() {
    // TODO: ê³„ì • ì‚­ì œ API êµ¬í˜„
    showToast('ê³„ì • ì‚­ì œ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.', 'info');
    hideDeleteModal();
}

function clearErrors() {
    document.querySelectorAll('.form-error').forEach(el => el.textContent = '');
}
</script>
{% endblock %}